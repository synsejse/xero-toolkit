# Maintainer: Kristián Kekeš <gamerix2006@gmail.com>
# Maintainer: Steve C. <steve@techxero.com>

pkgname=xero-toolkit
pkgver=0.1.8
pkgrel=2
pkgdesc="GTK4 GUI to manage XeroLinux specific tools and settings"
arch=('x86_64')
url="https://github.com/synsejse/xero-toolkit"
license=('GPL-3.0-or-later')
depends=(
    'gtk4'
    'glib2'
    'libadwaita'
    'vte4'
    'flatpak'
    'scx-tool'
    'polkit'
    'libdeflate')
optdepends=(
    'scxctl: SCX scheduler management for sched-ext kernels')
makedepends=(
    'rust'
    'cargo'
    'pkgconf')
provides=('xero-toolkit')
conflicts=('xero-toolkit')
replaces=('xlapit-cli')
# !lto is needed to avoid issues with libdeflate causing undefined symbols
options=('!emptydirs' '!lto')

build() {
  cd "${startdir}/.."

  cargo build --release --locked
}

package() {
  cd "${startdir}/.."

  # Install binaries into /opt/xero-toolkit
  install -d "${pkgdir}/opt/xero-toolkit"
  install -Dm755 "target/release/xero-toolkit" \
    "${pkgdir}/opt/xero-toolkit/xero-toolkit"
  install -Dm755 "target/release/xero-authd" \
    "${pkgdir}/opt/xero-toolkit/xero-authd"
  install -Dm755 "target/release/xero-auth" \
    "${pkgdir}/opt/xero-toolkit/xero-auth"

  # Install sources (scripts and systemd units)
  install -d "${pkgdir}/opt/xero-toolkit/sources/scripts"
  install -d "${pkgdir}/opt/xero-toolkit/sources/systemd"
  install -m755 sources/scripts/* "${pkgdir}/opt/xero-toolkit/sources/scripts/"
  install -m644 sources/systemd/* "${pkgdir}/opt/xero-toolkit/sources/systemd/"

  # Convenience symlink in /usr/bin
  install -d "${pkgdir}/usr/bin"
  ln -s "/opt/xero-toolkit/xero-toolkit" "${pkgdir}/usr/bin/xero-toolkit"

  # Install desktop file
  install -Dm644 "packaging/xero-toolkit.desktop" \
    "${pkgdir}/usr/share/applications/xero-toolkit.desktop"

  # Install icon
  install -Dm644 "gui/resources/icons/scalable/apps/xero-toolkit.png" \
    "${pkgdir}/usr/share/icons/hicolor/scalable/apps/xero-toolkit.png"

  # Install license
  install -Dm644 "LICENSE" \
    "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}

post_install() {
  gtk-update-icon-cache -q -t -f usr/share/icons/hicolor
}

post_upgrade() {
  post_install
}

post_remove() {
  gtk-update-icon-cache -q -t -f usr/share/icons/hicolor
}
